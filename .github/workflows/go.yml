name: go

on:
  schedule:
    - cron: '05 16 * * *'
  push:
    branches:
      - master

jobs:
  go:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        branch: [master, release-branch.go1.22, release-branch.go1.21, release-branch.go1.20, release-branch.go1.19, release-branch.go1.17]
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
    steps:
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          check-latest: true
      - uses: actions/checkout@v4
      - name: Setup
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt update -yq
          sudo DEBIAN_FRONTEND=noninteractive apt install -yq bzip2
      - name: Clone
        run: |
          git clone -b ${{ matrix.branch }} --single-branch https://github.com/golang/go
          sudo mv go /opt/
      - name: Patch 01-goenv.patch
        run: |
          patch -p1 -d /opt/go < 01-goenv.patch
      - name: Patch 02-http2date.patch
        if: matrix.branch == 'master'
        run: |
          patch -p1 -d /opt/go < 02-http2date.patch
      - name: Patch 03-tlsclienthello.patch
        if: matrix.branch == 'release-branch.go1.22'
        run: |
          patch -p1 -d /opt/go < 03-tlsclienthello.patch
      - name: Make
        run: |
          cd /opt/go/src
          osarch=${{ matrix.goos }}_${{ matrix.goarch }}
          cgo_enabled=0
          if [ "$osarch" = "linux_amd64" ] || [ "$osarch" = "linux_amd64" ]; then
             cgo_enabled=1
          fi
          env CGO_ENABLED=${cgo_enabled} GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} ./make.bash
      - name: Tarball
        run: |
          cd /opt/go/bin
          test -d ${{ matrix.goos }}_${{ matrix.goarch }} && rm -f go gofmt && mv -f ${{ matrix.goos }}_${{ matrix.goarch }}/* . && rmdir ${{ matrix.goos }}_${{ matrix.goarch }}
          cd /opt
          gover=$(echo ${{ matrix.branch }} | grep -oP 'go1.+' || echo gotip)
          tar c go | xz -9 -T 4 >/tmp/${gover}.${{ matrix.goos }}-${{ matrix.goarch }}.tar.xz
      - name: Release
        run: |
          curl -L https://github.com/github-release/github-release/releases/download/v0.10.0/linux-amd64-github-release.bz2 | bzip2 -d >github-release
          chmod +x github-release
          gover=$(echo ${{ matrix.branch }} | grep -oP 'go1.+' || echo gotip)
          ./github-release upload --replace --user phuslu --repo go --tag v0.0.0 --name ${gover}.${{ matrix.goos }}-${{ matrix.goarch }}.tar.xz --file /tmp/${gover}.${{ matrix.goos }}-${{ matrix.goarch }}.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GOTIP_TOKEN }}
